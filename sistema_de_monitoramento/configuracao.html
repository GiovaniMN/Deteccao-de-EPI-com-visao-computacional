<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@300;400;500;600;700;800"
    />
    <title>Configura√ß√£o - Jupiter Supervision</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/external-topaz-kerismaker/48/external-Jupiter-space-topaz-kerismaker.png" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script type="module" src="./static/js/authGuard.js"></script>
    <link rel="stylesheet" href="./static/css/configuracao.css">
</head>
<body class="bg-gray-900 text-white">
    <!-- Header -->
    <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700/50 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <button id="sidebarToggle" class="p-2 hover:bg-gray-700 rounded-lg transition-colors lg:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-white/10">
                            <img src="https://img.icons8.com/external-topaz-kerismaker/48/external-Jupiter-space-topaz-kerismaker.png" alt="Logo Jupiter" class="w-8 h-8" />
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-white">Jupiter Supervision</h1>
                            <p class="text-xs text-gray-400">Configura√ß√£o do Sistema</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    </header>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-800/30 backdrop-blur-sm border-r border-gray-700/50 transition-all duration-300 lg:translate-x-0 -translate-x-full fixed lg:relative z-40 h-full flex flex-col">
            <div class="p-6">
                <nav class="space-y-2">
                    <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-gray-700/50 rounded-xl transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                        </svg>
                        <span class="font-medium">Dashboard</span>
                    </a>
                    <a href="historico.html" class="flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-gray-700/50 rounded-xl transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="font-medium">Ocorr√™ncias</span>
                    </a>
                    <a href="usuarios.html" class="flex items-center space-x-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-gray-700/50 rounded-xl transition-all">
                        <span class="material-symbols-outlined text-xl">
                            user_attributes
                        </span>
                        <span class="font-medium">Usu√°rios</span>
                    </a>
                    <a href="configuracao.html" class="flex items-center space-x-3 px-4 py-3 bg-blue-600/20 text-blue-400 rounded-xl border border-blue-500/30">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="font-medium">Configura√ß√£o</span>
                    </a>
                </nav>
            </div>
            <a href="login.html" class="flex items-center space-x-3 px-6 py-4 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-xl transition-all mt-auto mx-6 mb-6">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                <span class="font-medium">Sair</span>
            </a>
        </aside>

        <!-- Main Content -->
        <main class="flex-1">
            <div class="p-4 sm:p-6 max-w-7xl mx-auto">
                <!-- Page Header -->
                <div class="mb-8">
                    <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2">Configura√ß√£o da Zona de Detec√ß√£o</h1>
                    <p class="text-gray-400">Desenhe um ret√¢ngulo na imagem mais recente para definir onde os objetos ser√£o detectados.</p>
                </div>

                <!-- Zone Configuration Area -->
                <div class="area-deteccao-header mb-6">
                <div class="flex items-center space-x-3">
                    <h2 class="area-titulo">√Årea de Detec√ß√£o</h2>
                    <div id="status-indicator" class="w-3 h-3 bg-yellow-500 rounded-full status-indicator"></div>
                </div>
                
                <div class="btn-group">
                    <button id="refreshImageButton" class="refresh-button flex items-center justify-center space-x-2 py-2.5 px-4 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>Atualizar Imagem</span>
                    </button>
                    
                    <button id="clearButton" class="secondary-button flex items-center justify-center space-x-2 py-2.5 px-4 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        <span>Limpar Zona</span>
                    </button>
                    
                    <button id="saveButton" class="action-button flex items-center justify-center space-x-2 py-2.5 px-4 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Salvar Zona</span>
                    </button>
                </div>
            </div>

                    <!-- Image Status -->
                    <div class="mb-4 p-3 bg-gray-700/30 rounded-lg border border-gray-600/50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div id="image-loading" class="loading-spinner hidden"></div>
                                <div>
                                    <p class="text-sm text-gray-300">Status da Imagem:</p>
                                    <p id="image-status-text" class="text-xs text-gray-400">Carregando √∫ltima ocorr√™ncia...</p>
                                </div>
                            </div>
                            <div id="image-timestamp" class="text-xs text-gray-500">-</div>
                        </div>
                    </div>

                    <!-- Image and Canvas Container -->
                    <div id="image-container" class="mx-auto bg-gray-900 rounded-xl overflow-hidden shadow-2xl border border-gray-700/50 relative">
                        <div id="no-image-placeholder" class="flex flex-col items-center justify-center h-96 text-center">
                            <div class="loading-spinner mb-4"></div>
                            <h3 class="text-lg font-semibold text-gray-300 mb-2">Carregando imagem...</h3>
                            <p class="text-sm text-gray-400">Buscando a imagem mais recente da base de dados</p>
                        </div>
                        <img id="reference-image" alt="√öltima imagem capturada" class="w-full h-auto hidden">
                        <canvas id="zone-canvas"></canvas>
                        <div id="image-error" class="hidden flex flex-col items-center justify-center h-96 text-center">
                            <svg class="w-16 h-16 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-red-300 mb-2">Erro ao carregar imagem</h3>
                            <p class="text-sm text-gray-400 mb-4">N√£o foi poss√≠vel carregar a imagem mais recente</p>
                            <button id="retryLoadImage" class="action-button text-white font-semibold py-2 px-4 rounded-lg">
                                Tentar Novamente
                            </button>
                        </div>
                    </div>
                    
                    <!-- Zone Information Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <!-- Coordinates Display -->
                        <div class="coordinate-display rounded-xl p-4">
                            <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Coordenadas Web (640x480)
                            </h3>
                            <div id="coordinates" class="text-sm text-gray-300 space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Status:</span>
                                    <span id="zone-status" class="text-yellow-400">Nenhuma zona definida</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">X:</span>
                                    <span id="coord-x" class="text-white">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Y:</span>
                                    <span id="coord-y" class="text-white">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Largura:</span>
                                    <span id="coord-width" class="text-white">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Altura:</span>
                                    <span id="coord-height" class="text-white">-</span>
                                </div>
                                <div class="flex justify-between pt-2 border-t border-gray-700">
                                    <span class="text-gray-500">√Årea:</span>
                                    <span id="zone-area" class="text-blue-400 font-medium">- px¬≤</span>
                                </div>
                            </div>
                        </div>

                        <!-- Camera Coordinates Preview -->
                        <div class="coordinate-display rounded-xl p-4">
                            <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Coordenadas C√¢mera (1920x1080)
                            </h3>
                            <div id="camera-coordinates" class="text-sm text-gray-300 space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">X:</span>
                                    <span id="cam-coord-x" class="text-green-400">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Y:</span>
                                    <span id="cam-coord-y" class="text-green-400">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Largura:</span>
                                    <span id="cam-coord-width" class="text-green-400">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Altura:</span>
                                    <span id="cam-coord-height" class="text-green-400">-</span>
                                </div>
                                <div class="flex justify-between pt-2 border-t border-gray-700">
                                    <span class="text-gray-500">Escala:</span>
                                    <span id="scale-factor" class="text-green-400 font-medium">2.0x / 1.5x</span>
                                </div>
                            </div>
                        </div>

                        <!-- Instructions Card -->
                        <div class="zone-info-card rounded-xl p-4">
                            <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Como usar
                            </h3>
                            <div class="text-sm text-gray-300 space-y-2">
                                <div class="flex items-start space-x-2">
                                    <div class="w-2 h-2 bg-blue-400 rounded-full mt-2 flex-shrink-0"></div>
                                    <span>A imagem mais recente √© carregada automaticamente</span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <div class="w-2 h-2 bg-green-400 rounded-full mt-2 flex-shrink-0"></div>
                                    <span>Clique e arraste na imagem para desenhar a zona</span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <div class="w-2 h-2 bg-yellow-400 rounded-full mt-2 flex-shrink-0"></div>
                                    <span>Use "Atualizar Imagem" para recarregar</span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <div class="w-2 h-2 bg-purple-400 rounded-full mt-2 flex-shrink-0"></div>
                                    <span>Salve a zona para aplicar na detec√ß√£o</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Debug Information -->
                    <div class="mt-6">
                        <div class="debug-info rounded-xl p-4">
                            <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Informa√ß√µes de Debug
                            </h3>
                            <div id="debug-info" class="text-xs text-gray-300 space-y-1">
                                <div>Resolu√ß√£o Web de Refer√™ncia: 640x480px</div>
                                <div>Resolu√ß√£o da C√¢mera: 1280x720px</div>
                                <div>Fator de Escala X: 2.0 (1280/640)</div>
                                <div>Fator de Escala Y: 1.5 (720/480)</div>
                                <div>Canvas Atual: <span id="canvas-size">-</span></div>
                                <div>Imagem Carregada: <span id="image-loaded-status">N√£o</span></div>
                                <div>√öltima Opera√ß√£o: <span id="last-operation">Aguardando...</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Feedback Message -->
                    <div id="feedback" class="mt-6 text-center text-sm transition-all duration-300"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden"></div>

    <!-- Firebase SDK e Script Principal -->
    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBkgN9tJxWc3jVPSQ6DpQpOhNhFZyi5W3Y",
            authDomain: "jupiter-supervision.firebaseapp.com",
            projectId: "jupiter-supervision",
            storageBucket: "jupiter-supervision.appspot.com",
            messagingSenderId: "118412161335",
            appId: "1:118412161335:web:13aa2d9bc240935db56ab2",
            measurementId: "G-GNL7NRGM1S",
            databaseURL: "https://jupiter-supervision-default-rtdb.firebaseio.com/"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        console.log('üöÄ Firebase inicializado com sucesso!');

        // CORRE√á√ÉO: Constantes de resolu√ß√£o para sincroniza√ß√£o
        const WEB_REFERENCE_RESOLUTION = { width: 640, height: 480 };
        const CAMERA_RESOLUTION = { width: 1280, height: 720 };
        const SCALE_X = CAMERA_RESOLUTION.width / WEB_REFERENCE_RESOLUTION.width;   // 2.0
        const SCALE_Y = CAMERA_RESOLUTION.height / WEB_REFERENCE_RESOLUTION.height; // 1.5

        const canvas = document.getElementById('zone-canvas');
        const img = document.getElementById('reference-image');
        const ctx = canvas.getContext('2d');
        const statusIndicator = document.getElementById('status-indicator');
        const noImagePlaceholder = document.getElementById('no-image-placeholder');
        const imageError = document.getElementById('image-error');
        const imageStatusText = document.getElementById('image-status-text');
        const imageTimestamp = document.getElementById('image-timestamp');
        const imageLoadingSpinner = document.getElementById('image-loading');
        
        let startX, startY, endX, endY;
        let drawing = false;
        let zone = null;
        let currentImageData = null;

        function updateDebugInfo(operation) {
            document.getElementById('canvas-size').textContent = `${canvas.width}x${canvas.height}px`;
            document.getElementById('last-operation').textContent = operation;
            document.getElementById('image-loaded-status').textContent = currentImageData ? 'Sim' : 'N√£o';
        }

        function showImageLoading(show = true) {
            if (show) {
                imageLoadingSpinner.classList.remove('hidden');
                imageStatusText.textContent = 'Carregando imagem...';
                imageStatusText.className = 'text-xs text-yellow-400';
            } else {
                imageLoadingSpinner.classList.add('hidden');
            }
        }

        function showImageError(message = 'Erro ao carregar imagem') {
            noImagePlaceholder.classList.add('hidden');
            img.classList.add('hidden');
            imageError.classList.remove('hidden');
            
            imageStatusText.textContent = message;
            imageStatusText.className = 'text-xs text-red-400';
            imageTimestamp.textContent = '-';
            
            updateDebugInfo('Erro ao carregar imagem');
        }

        function showImageSuccess(timestamp) {
            noImagePlaceholder.classList.add('hidden');
            imageError.classList.add('hidden');
            img.classList.remove('hidden');
            
            imageStatusText.textContent = 'Imagem carregada com sucesso';
            imageStatusText.className = 'text-xs text-green-400';
            
            const date = new Date(timestamp);
            imageTimestamp.textContent = date.toLocaleString('pt-BR');
            
            updateDebugInfo('Imagem carregada com sucesso');
        }

        async function loadLatestImage() {
            try {
                console.log('üì∏ Carregando imagem mais recente...');
                showImageLoading(true);

                const alertasCollection = collection(db, 'alertas_epi');
                const q = query(alertasCollection, orderBy('data_hora', 'desc'), limit(1));
                const snapshot = await getDocs(q);

                showImageLoading(false);

                if (snapshot.empty) {
                    console.log('‚ùå Nenhuma imagem encontrada na cole√ß√£o alertas_epi');
                    showImageError('Nenhuma imagem encontrada na base de dados');
                    showFeedback('Nenhuma imagem encontrada. Adicione ocorr√™ncias para poder configurar a zona.', 'warning');
                    return;
                }

                const doc = snapshot.docs[0];
                const data = doc.data();
                currentImageData = data;

                console.log('üìÑ Dados da imagem mais recente:', {
                    id: doc.id,
                    data_hora: data.data_hora,
                    mensagem: data.mensagem,
                    hasImage: !!data.imagem_base64
                });

                if (!data.imagem_base64) {
                    console.log('‚ùå Imagem base64 n√£o encontrada no documento');
                    showImageError('Imagem n√£o dispon√≠vel no documento');
                    showFeedback('A ocorr√™ncia mais recente n√£o cont√©m imagem.', 'error');
                    return;
                }

                // Carrega a imagem
                const imageDataUrl = `data:image/jpeg;base64,${data.imagem_base64}`;
                
                return new Promise((resolve, reject) => {
                    img.onload = () => {
                        console.log('‚úÖ Imagem carregada com sucesso!');
                        showImageSuccess(data.data_hora);
                        resizeCanvas();
                        listenForZoneChanges(); // Inicia o listener para a zona
                        showFeedback('Imagem carregada com sucesso! Agora voc√™ pode definir a zona de detec√ß√£o.', 'success');
                        resolve();
                    };
                    
                    img.onerror = () => {
                        console.log('‚ùå Erro ao carregar a imagem');
                        showImageError('Erro ao decodificar imagem');
                        showFeedback('Erro ao carregar a imagem. Tente novamente.', 'error');
                        reject(new Error('Erro ao carregar imagem'));
                    };
                    
                    img.src = imageDataUrl;
                });

            } catch (error) {
                console.error('‚ùå Erro ao buscar imagem mais recente:', error);
                showImageLoading(false);
                showImageError('Erro de conex√£o com a base de dados');
                showFeedback('Erro ao carregar imagem: ' + error.message, 'error');
                updateDebugInfo('Erro: ' + error.message);
            }
        }

        function resizeCanvas() {
            canvas.width = img.clientWidth;
            canvas.height = img.clientHeight;
            
            updateDebugInfo('Canvas redimensionado');
            
            if (zone) {
                drawZone();
            }
        }

        function drawZone() {
            if (!zone) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Desenha zona com estilo moderno
            ctx.fillStyle = 'rgba(59, 130, 246, 0.2)';
            ctx.fillRect(zone.x, zone.y, zone.width, zone.height);
            
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 3;
            ctx.setLineDash([]);
            ctx.strokeRect(zone.x, zone.y, zone.width, zone.height);
            
            // Desenha bordas dos cantos
            const cornerSize = 20;
            ctx.strokeStyle = '#60a5fa';
            ctx.lineWidth = 4;
            
            // Canto superior esquerdo
            ctx.beginPath();
            ctx.moveTo(zone.x, zone.y + cornerSize);
            ctx.lineTo(zone.x, zone.y);
            ctx.lineTo(zone.x + cornerSize, zone.y);
            ctx.stroke();
            
            // Canto superior direito
            ctx.beginPath();
            ctx.moveTo(zone.x + zone.width - cornerSize, zone.y);
            ctx.lineTo(zone.x + zone.width, zone.y);
            ctx.lineTo(zone.x + zone.width, zone.y + cornerSize);
            ctx.stroke();
            
            // Canto inferior esquerdo
            ctx.beginPath();
            ctx.moveTo(zone.x, zone.y + zone.height - cornerSize);
            ctx.lineTo(zone.x, zone.y + zone.height);
            ctx.lineTo(zone.x + cornerSize, zone.y + zone.height);
            ctx.stroke();
            
            // Canto inferior direito
            ctx.beginPath();
            ctx.moveTo(zone.x + zone.width - cornerSize, zone.y + zone.height);
            ctx.lineTo(zone.x + zone.width, zone.y + zone.height);
            ctx.lineTo(zone.x + zone.width, zone.y + zone.height - cornerSize);
            ctx.stroke();
            
            // Adiciona texto centralizado
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('ZONA DE DETEC√á√ÉO', 
                        zone.x + zone.width/2, 
                        zone.y + zone.height/2);
            
            updateDebugInfo('Zona desenhada no canvas');
        }

        function canvasToWebCoords(canvasZone) {
            // Converte coordenadas do canvas para coordenadas de refer√™ncia web (640x480)
            const scaleX = WEB_REFERENCE_RESOLUTION.width / canvas.width;
            const scaleY = WEB_REFERENCE_RESOLUTION.height / canvas.height;
            
            return {
                nome: canvasZone.nome || 'zona1',
                x: Math.round(canvasZone.x * scaleX),
                y: Math.round(canvasZone.y * scaleY),
                width: Math.round(canvasZone.width * scaleX),
                height: Math.round(canvasZone.height * scaleY)
            };
        }
        
        function webToCameraCoords(webZone) {
            // Converte coordenadas web para coordenadas da c√¢mera
            return {
                nome: webZone.nome,
                x: Math.round(webZone.x * SCALE_X),
                y: Math.round(webZone.y * SCALE_Y),
                width: Math.round(webZone.width * SCALE_X),
                height: Math.round(webZone.height * SCALE_Y)
            };
        }
        
        function webToCanvasCoords(webZone) {
            // Converte coordenadas web para coordenadas do canvas atual
            const scaleX = canvas.width / WEB_REFERENCE_RESOLUTION.width;
            const scaleY = canvas.height / WEB_REFERENCE_RESOLUTION.height;
            
            return {
                nome: webZone.nome,
                x: Math.round(webZone.x * scaleX),
                y: Math.round(webZone.y * scaleY),
                width: Math.round(webZone.width * scaleX),
                height: Math.round(webZone.height * scaleY)
            };
        }

        function updateCoordinatesDisplay() {
            const coordX = document.getElementById('coord-x');
            const coordY = document.getElementById('coord-y');
            const coordWidth = document.getElementById('coord-width');
            const coordHeight = document.getElementById('coord-height');
            const zoneArea = document.getElementById('zone-area');
            const zoneStatus = document.getElementById('zone-status');
            
            // Coordenadas da c√¢mera
            const camCoordX = document.getElementById('cam-coord-x');
            const camCoordY = document.getElementById('cam-coord-y');
            const camCoordWidth = document.getElementById('cam-coord-width');
            const camCoordHeight = document.getElementById('cam-coord-height');
            
            if (zone) {
                // Converte para coordenadas web de refer√™ncia
                const webZone = canvasToWebCoords(zone);
                const cameraZone = webToCameraCoords(webZone);
                
                // Coordenadas web (640x480)
                coordX.textContent = `${webZone.x}px`;
                coordY.textContent = `${webZone.y}px`;
                coordWidth.textContent = `${webZone.width}px`;
                coordHeight.textContent = `${webZone.height}px`;
                zoneArea.textContent = `${(webZone.width * webZone.height).toLocaleString()} px¬≤`;
                
                // Coordenadas da c√¢mera (1280x720)
                camCoordX.textContent = `${cameraZone.x}px`;
                camCoordY.textContent = `${cameraZone.y}px`;
                camCoordWidth.textContent = `${cameraZone.width}px`;
                camCoordHeight.textContent = `${cameraZone.height}px`;
                
                zoneStatus.textContent = 'Zona definida';
                zoneStatus.className = 'text-green-400';
                statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
                
                updateDebugInfo(`Coordenadas atualizadas - Web: ${webZone.x},${webZone.y} ${webZone.width}x${webZone.height} | C√¢mera: ${cameraZone.x},${cameraZone.y} ${cameraZone.width}x${cameraZone.height}`);
            } else {
                coordX.textContent = '-';
                coordY.textContent = '-';
                coordWidth.textContent = '-';
                coordHeight.textContent = '-';
                zoneArea.textContent = '- px¬≤';
                
                camCoordX.textContent = '-';
                camCoordY.textContent = '-';
                camCoordWidth.textContent = '-';
                camCoordHeight.textContent = '-';
                
                zoneStatus.textContent = 'Nenhuma zona definida';
                zoneStatus.className = 'text-yellow-400';
                statusIndicator.className = 'w-3 h-3 bg-yellow-500 rounded-full status-indicator';
            }
        }

        window.addEventListener('resize', resizeCanvas);
        
        function listenForZoneChanges() {
            try {
                const docRef = doc(db, 'configuracoes', 'zones');
                
                onSnapshot(docRef, (docSnap) => {
                    console.log("üî• Zona de detec√ß√£o atualizada em tempo real!");
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.zones && data.zones.length > 0) {
                            const existingWebZone = data.zones[0];
                            zone = webToCanvasCoords(existingWebZone);
                            console.log('‚úÖ Zona carregada e convertida:', existingWebZone, '=>', zone);
                            drawZone();
                            updateCoordinatesDisplay();
                            showFeedback('Zona de detec√ß√£o foi atualizada!', 'info');
                        } else {
                            // Se as zonas foram removidas, limpa o canvas
                            zone = null;
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            updateCoordinatesDisplay();
                            console.log('üìù Nenhuma zona encontrada no Firebase');
                        }
                    } else {
                        zone = null;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        updateCoordinatesDisplay();
                        console.log('üìù Documento de zonas n√£o existe.');
                    }
                });

            } catch (error) {
                console.error('‚ùå Erro ao escutar por zonas:', error);
                showFeedback('Erro ao carregar zona: ' + error.message, 'error');
            }
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!currentImageData) {
                showFeedback('Carregue uma imagem antes de definir a zona.', 'warning');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            drawing = true;
            console.log('üñ±Ô∏è In√≠cio do desenho:', startX, startY);
            updateDebugInfo(`In√≠cio do desenho: ${startX},${startY}`);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!drawing || !currentImageData) return;
            
            const rect = canvas.getBoundingClientRect();
            endX = e.clientX - rect.left;
            endY = e.clientY - rect.top;
            
            const width = endX - startX;
            const height = endY - startY;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Desenha zona tempor√°ria
            ctx.fillStyle = 'rgba(59, 130, 246, 0.2)';
            ctx.fillRect(startX, startY, width, height);
            
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(startX, startY, width, height);
        });

        canvas.addEventListener('mouseup', () => {
            if (!drawing || !currentImageData) return;
            
            drawing = false;
            const width = endX - startX;
            const height = endY - startY;
            
            console.log('üèÅ Fim do desenho:', endX, endY);
            
            if (Math.abs(width) < 10 || Math.abs(height) < 10) {
                console.log('‚ö†Ô∏è Zona muito pequena, ignorando');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                updateDebugInfo('Zona muito pequena - ignorada');
                showFeedback('Zona muito pequena. Desenhe uma √°rea maior.', 'warning');
                return;
            }
            
            zone = {
                nome: 'zona1',
                x: Math.round(Math.min(startX, endX)),
                y: Math.round(Math.min(startY, endY)),
                width: Math.round(Math.abs(width)),
                height: Math.round(Math.abs(height))
            };
            
            console.log('‚úÖ Nova zona criada:', zone);
            drawZone();
            updateCoordinatesDisplay();
            showFeedback('Zona definida! Clique em "Salvar Zona" para confirmar.', 'info');
        });

        document.getElementById('saveButton').addEventListener('click', async () => {
            if (!zone) {
                showFeedback('Nenhuma zona definida.', 'error');
                return;
            }
            
            if (!currentImageData) {
                showFeedback('Carregue uma imagem antes de salvar a zona.', 'warning');
                return;
            }
            
            try {
                console.log('üíæ Salvando zona...', zone);
                
                // CORRE√á√ÉO: Converte coordenadas do canvas para coordenadas web de refer√™ncia
                const webZone = canvasToWebCoords(zone);
                const cameraZone = webToCameraCoords(webZone);
                
                console.log('üìä Convers√µes:');
                console.log('  Canvas:', zone);
                console.log('  Web (640x480):', webZone);
                console.log('  C√¢mera (1280x720):', cameraZone);
                
                const docRef = doc(db, 'configuracoes', 'zones');
                
                // Salva as coordenadas web (que ser√£o convertidas pela aplica√ß√£o)
                await setDoc(docRef, {
                    zones: [webZone],
                    lastUpdated: new Date().toISOString(),
                    baseImage: {
                        timestamp: currentImageData.data_hora,
                        message: currentImageData.mensagem
                    },
                    debug_info: {
                        canvas_size: `${canvas.width}x${canvas.height}`,
                        web_reference: `${WEB_REFERENCE_RESOLUTION.width}x${WEB_REFERENCE_RESOLUTION.height}`,
                        camera_resolution: `${CAMERA_RESOLUTION.width}x${CAMERA_RESOLUTION.height}`,
                        scale_factors: `${SCALE_X}x${SCALE_Y}`,
                        canvas_zone: zone,
                        camera_zone: cameraZone
                    }
                });
                
                console.log('‚úÖ Zona salva com sucesso no Firebase!');
                statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
                showFeedback('Zona salva com sucesso! A aplica√ß√£o ser√° sincronizada automaticamente.', 'success');
                updateDebugInfo(`Zona salva - Web: ${webZone.x},${webZone.y} ${webZone.width}x${webZone.height}`);
                
            } catch (err) {
                console.error('‚ùå Erro ao salvar zona:', err);
                showFeedback('Erro ao salvar: ' + err.message, 'error');
                updateDebugInfo('Erro ao salvar: ' + err.message);
            }
        });

        document.getElementById('clearButton').addEventListener('click', () => {
            console.log('üóëÔ∏è Limpando zona...');
            zone = null;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updateCoordinatesDisplay();
            showFeedback('Zona limpa. Desenhe uma nova zona.', 'warning');
            updateDebugInfo('Zona limpa pelo usu√°rio');
        });

        document.getElementById('refreshImageButton').addEventListener('click', () => {
            console.log('üîÑ Recarregando imagem...');
            loadLatestImage();
        });

        document.getElementById('retryLoadImage').addEventListener('click', () => {
            console.log('üîÑ Tentando carregar imagem novamente...');
            loadLatestImage();
        });

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            const colors = {
                success: 'text-green-400 bg-green-500/10 border border-green-500/20',
                error: 'text-red-400 bg-red-500/10 border border-red-500/20',
                warning: 'text-yellow-400 bg-yellow-500/10 border border-yellow-500/20',
                info: 'text-blue-400 bg-blue-500/10 border border-blue-500/20'
            };
            
            console.log(`üì¢ Feedback (${type}):`, message);
            
            feedback.textContent = message;
            feedback.className = `mt-6 text-center text-sm p-3 rounded-lg transition-all duration-300 ${colors[type] || colors.info}`;
            
            setTimeout(() => {
                feedback.className = 'mt-6 text-center text-sm transition-all duration-300';
                feedback.textContent = '';
            }, 5000);
        }

        // Sidebar toggle
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        
        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        }
        
        if (sidebarToggle) sidebarToggle.addEventListener('click', toggleSidebar);
        if (sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);

        // Inicializa√ß√£o
        updateCoordinatesDisplay();
        updateDebugInfo('Sistema inicializado');
        
        // Carrega a imagem mais recente automaticamente
        loadLatestImage();
        
        console.log('üé¨ Sistema de configura√ß√£o de zona inicializado com imagem din√¢mica!');
        console.log(`üìê Fatores de escala: X=${SCALE_X}, Y=${SCALE_Y}`);
    </script>
    <script type="module" src="./static/js/logout.js"></script>
</body>
</html>
